"use strict";var t=require("../../../common/vendor.js");const e={data(){return{content:"",list:this.getList(),status:"正在加载留言",timer:null,onLogin:!1}},onLoad(){this.timer=setInterval((()=>this.getList()),2500)},onUnload(){clearInterval(this.timer)},onShow(){this.onLogin||(this.onLogin=!0,this.content&&t.index.getStorageSync("token")&&this.publish())},methods:{checkToken(){if(!t.index.getStorageSync("token"))return t.index.showToast({title:"请先登录",icon:"error"}),t.index.navigateTo({url:"/pages/ucenter/login/login"}),void(this.onLogin=!0)},getList(e){t.pn.callFunction({name:"fun",data:{api:e||"getMessages"}}).then((t=>{this.list=t.result.data,this.status=0==this.list?"留言板是空的":"所有留言内容"}))},publish(){if(!1!==this.onLogin)return this.content.trim()?void t.pn.callFunction({name:"fun",data:{api:"addMessage",args:{content:this.content},token:t.index.getStorageSync("token")}}).then((e=>{if(!1===e.result.success)throw Error();this.status="留言成功",t.index.showToast({title:"留言成功",icon:"success"}),this.content=""})).catch((e=>{console.log(e),t.index.showToast({title:"留言失败",icon:"error"})})):(t.index.showToast({title:"留言无效",icon:"error"}),void(this.status="留言无效"))}}};var n=t._export_sfc(e,[["render",function(e,n,o,i,s,a){return{a:s.content,b:t.o((t=>s.content=t.detail.value)),c:t.o((t=>(a.checkToken(),a.publish()))),d:t.t(s.status),e:t.f(s.list,((e,n,o)=>({a:t.t(e.content),b:t.t(e.time),c:e.backgroundColor,d:e._id})))}}]]);wx.createPage(n);
